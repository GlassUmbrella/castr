<% include ../partials/header %>
<% include ../partials/menu %>

<script>
	function PodcastsIndexViewModel() {
		self.podcasts = <%-JSON.stringify(podcasts) %>;

		self.selectedPodcastId = ko.observable(0);

		self.selectedPodcast = function() {
			for (var i = 0; i < self.podcasts.length; i++) {
				var podcast = self.podcasts[i];
				if (podcast.id == self.selectedPodcastId()) {
					return podcast;
				}
			}
		}

		self.episodes = ko.observable([]);

		self.selectPodcast = function() {
			var podcastId = this.id;
			selectedPodcastId(podcastId);
			self.updateEpisodes();
		};

		self.selectPodcastId = function(podcastId) {
			selectedPodcastId(podcastId);
			self.updateEpisodes();
		}

		self.updateEpisodes = function() {
			var podcastId = self.selectedPodcastId();
			$.getJSON("/api/podcasts/{0}/episodes".format(podcastId), function(data) {
				self.episodes(data.result);
				history.pushState(null, "", "/podcasts/{0}".format(podcastId));
			});
		}

		self.selectedPodcastUrl = function() {
			var podcast = self.selectedPodcast();
			return "http://{0}.castr.net".format(podcast.url);
		}

		return self;
	}
	
	$(function() {
		var podcastsIndexViewModel = new PodcastsIndexViewModel();
		
		for (var i = 0; i < podcastsIndexViewModel.podcasts; i++) {
			var podcast = podcastsIndexViewModel.podcasts[i];
			podcast.latestEpisode(getLatestEpisode(podcast.podcastId));
		}

		var selectedPodcastId = <%= selectedPodcastId %>;

		if (selectedPodcastId > 0) {
			podcastsIndexViewModel.selectPodcastId(selectedPodcastId);
		} else {
			if (podcastsIndexViewModel.podcasts.length > 0) {
				podcastsIndexViewModel.selectPodcastId(podcastsIndexViewModel.podcasts[0].id);
			}
		}

		ko.applyBindings(podcastsIndexViewModel);
	});
</script>

<h3>My Podcasts</h3>
<hr>
<div class="row">
	<div class="span3">
		<ul class="nav nav-list nav-list-vivid">
	        <!-- ko if: podcasts.length > 0 -->
		        <li class="nav-header">Podcasts</li>
		        <!-- ko foreach: podcasts -->
		            <li data-bind="attr: { class: selectedPodcastId() == id ? 'active' : '' }">
		            	<a href="#" data-bind="click: selectPodcast">
		            		<span data-bind="text: title"></span>
		              	</a>
		            </li>
	            <!-- /ko -->
            <!-- /ko -->
            <li class="nav-header">Create</li>
            <li>
				<a href="/podcasts/create">
					<span class="fui-plus"></span> Create new podcast
				</a>	
			</li>
		</ul>
	</div>
	<div class="span7">
		<!-- ko if: podcasts.length > 0 -->
			<table class="table table-bordered">
				<thead>
					<tr>
						<th class="span1">Episode</th>
						<th>Title</th>
						<th>Published Date</th>
					</tr>
				</thead>
				<!-- ko if: episodes().length > 0 -->
					<tbody data-bind="foreach: episodes">
						<tr>
						<!-- ko if: episodeNumber > 0 -->
							<td>
								<span class="label label-large label-primary" data-bind="text: '#' + episodeNumber"></span>
							</td>
						<!-- /ko -->
						<!-- ko if: !episodeNumber -->
							<td>
								<span class="label label-large label-secondary">Draft</span>
							</td>
						<!-- /ko -->
							<td>
								<a data-bind="text: title, attr: { href: '/podcasts/' + PodcastId + '/episodes/' + id }"></a>
							</td>
							<td>
								<span data-bind="text: publishDate"></span>
							</td>
						</tr>
					</tbody>
				<!-- /ko -->
				<!-- ko if: episodes().length == 0 -->
					<tbody>
						<td colspan="4">You haven&#39;t recorded any episodes</td>
					</tbody>
				<!-- /ko -->
			</table>
		<!-- /ko -->
		<!-- ko if: podcasts.length == 0 -->
			<p>You don't have any podcasts.</p>
			<p><a href="/podcasts/create" class="btn btn-large btn-primary">Create My First Podcast</a></p>
		<!-- /ko -->
	</div>

	<!-- ko if: podcasts.length > 0 -->
		<div class="span2">
			<div class="iconbar pull-right">
	            <ul>
		            <li>
		            	<a href="" class="fui-plus" data-bind="attr: { href: '/podcasts/{0}/episodes/create'.format(selectedPodcast().id) }"></a>
		            </li>
		            <li><a data-bind="attr: { href: selectedPodcastUrl() }" class="fui-upload"></a></li>
		            <li><a href="#fakelink" class="fui-chat"></a></li>
		            <li><a href="#fakelink" class="fui-mail">
			                <span class="iconbar-unread">1</span></a></li>
		            <li>
		                <a href="#fakelink" class="fui-gear">
		                </a>
		            </li>
	            </ul>
	        </div>
	    </div>
	<!-- /ko -->
</div>

<% include ../partials/footer %>
